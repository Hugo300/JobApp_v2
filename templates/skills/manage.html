{% extends "base.html" %}

{% block title %}Skills & Categories Management{% endblock %}

{% block extra_css %}
<style>
.category-item {
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.category-item:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.skill-tag {
    display: inline-block;
    margin: 2px;
    padding: 4px 8px;
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.skill-tag:hover {
    background-color: #e9ecef;
    cursor: pointer;
}

.skill-tag .usage-count {
    background-color: #6c757d;
    color: white;
    border-radius: 8px;
    padding: 1px 6px;
    font-size: 0.75rem;
    margin-left: 4px;
}

.loading-spinner {
    display: none;
}

.alert-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    max-width: 400px;
}

.stats-card {
    transition: transform 0.2s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.tab-content {
    min-height: 500px;
}

.category-items-preview {
    max-height: 200px;
    overflow-y: auto;
}

.category-list-item {
    cursor: pointer;
    transition: all 0.2s ease;
}

.category-list-item:hover {
    background-color: #f8f9fa;
}

.category-list-item.active {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.category-item-card {
    transition: transform 0.2s ease;
}

.category-item-card:hover {
    transform: translateY(-2px);
}

.search-box {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
    padding: 10px 0;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 15px;
}
</style>
{% endblock %}

{% block content %}
<!-- Alert Container -->
<div class="alert-container" id="alertContainer"></div>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-cogs me-2"></i>Skills & Categories Management</h2>
                    <p class="text-muted mb-0">Manage skill categories, industries, and blacklisted terms</p>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    <a href="{{ url_for('skills.skill_analytics') }}" class="btn btn-primary">
                        <i class="fas fa-chart-line me-1"></i>Analytics
                    </a>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                        <i class="fas fa-plus me-1"></i>New Category
                    </button>
                    <button class="btn btn-info" onclick="autoAssignIndustries()" id="autoAssignBtn">
                        <i class="fas fa-magic me-1"></i>Auto-Assign Industries
                        <span class="loading-spinner spinner-border spinner-border-sm ms-2" role="status"></span>
                    </button>
                    <button class="btn btn-warning" onclick="refreshSuggestions()" id="refreshSuggestionsBtn">
                        <i class="fas fa-sync me-1"></i>Refresh Suggestions
                        <span class="loading-spinner spinner-border spinner-border-sm ms-2" role="status"></span>
                    </button>
                    <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Statistics Overview -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="totalSkillsCount">{{ skill_stats.total_skills or 0 }}</h4>
                            <p class="mb-0">Total Skills</p>
                            <small class="opacity-75">{{ skill_stats.categorized_skills or 0 }} categorized</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cogs fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="totalIndustriesCount">{{ industry_stats.total_industries or 0 }}</h4>
                            <p class="mb-0">Industries</p>
                            <small class="opacity-75">{{ industry_stats.jobs_with_industry or 0 }} jobs assigned</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-industry fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="coveragePercentage">{{ industry_stats.coverage_percentage or 0 }}%</h4>
                            <p class="mb-0">Industry Coverage</p>
                            <small class="opacity-75">Job classification rate</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-pie fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card stats-card bg-danger text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-0" id="blacklistedCount">{{ blacklisted_skills|length or 0 }}</h4>
                            <p class="mb-0">Blacklisted</p>
                            <small class="opacity-75">
                                {% if suggestions %}
                                    {{ suggestions|length }} suggestions
                                {% else %}
                                    No suggestions
                                {% endif %}
                            </small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-ban fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="managementTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                <i class="fas fa-layer-group me-1"></i>Categories
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="industries-tab" data-bs-toggle="tab" data-bs-target="#industries" type="button" role="tab">
                <i class="fas fa-industry me-1"></i>Industries
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="blacklist-tab" data-bs-toggle="tab" data-bs-target="#blacklist" type="button" role="tab">
                <i class="fas fa-ban me-1"></i>Blacklist
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="suggestions-tab" data-bs-toggle="tab" data-bs-target="#suggestions" type="button" role="tab">
                <i class="fas fa-exclamation-triangle me-1"></i>Suggestions
                {% if suggestions %}
                    <span class="badge bg-warning ms-1">{{ suggestions|length }}</span>
                {% endif %}
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="managementTabsContent">

        <!-- Enhanced Categories Tab -->
        <div class="tab-pane fade show active" id="categories" role="tabpanel">
            <div class="row">
                <!-- Categories List -->
                <div class="col-lg-4 col-md-5">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-list me-2"></i>Categories
                                    <span class="badge bg-primary ms-2">{{ (skill_categories|length) + (industry_categories|length) }}</span>
                                </h5>
                                <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div class="mt-2">
                                <input type="text" class="form-control form-control-sm"
                                       placeholder="Search categories..."
                                       onkeyup="filterCategoriesList(this.value)" id="categorySearchInput">
                            </div>
                        </div>
                        <div class="card-body p-0" id="categories-list">
                            <div class="list-group list-group-flush">
                                <!-- Skill Categories -->
                                {% for category in skill_categories %}
                                <div class="list-group-item category-list-item"
                                     data-category-id="{{ category.id }}"
                                     data-category-name="{{ category.name|lower }}"
                                     data-category-type="skill"
                                     onclick="selectCategory({{ category.id }}, 'skill')">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <i class="{{ category.icon }} me-2" style="color: {{ category.color }}"></i>
                                                <div>
                                                    <h6 class="mb-0">{{ category.name }}</h6>
                                                    <small class="text-muted">{{ category.category_items|length }} items</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            {% if category.is_system %}
                                                <span class="badge bg-secondary">System</span>
                                            {% endif %}
                                            <span class="badge bg-primary">{{ category.category_items|length }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}

                                <!-- Industry Categories -->
                                {% for category in industry_categories %}
                                <div class="list-group-item category-list-item"
                                     data-category-id="{{ category.id }}"
                                     data-category-name="{{ category.name|lower }}"
                                     data-category-type="industry"
                                     onclick="selectCategory({{ category.id }}, 'industry')">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <div class="d-flex align-items-center">
                                                <i class="{{ category.icon }} me-2" style="color: {{ category.color }}"></i>
                                                <div>
                                                    <h6 class="mb-0">{{ category.name }}</h6>
                                                    <small class="text-muted">{{ category.category_items|length }} items</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-success">Industry</span>
                                            <span class="badge bg-primary">{{ category.category_items|length }}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            {% if not skill_categories %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-layer-group fa-3x mb-3"></i>
                                <p>No skill categories found. Create your first category!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Category Details Panel -->
                <div class="col-lg-8 col-md-7">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0" id="categoryDetailsTitle">
                                    <i class="fas fa-info-circle me-2"></i>Select a Category
                                </h5>
                                <div class="btn-group" id="categoryActions" style="display: none;">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editSelectedCategory()">
                                        <i class="fas fa-edit me-1"></i>Edit
                                    </button>
                                    <button class="btn btn-sm btn-success" onclick="addItemToSelectedCategory()">
                                        <i class="fas fa-plus me-1"></i>Add Item
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSelectedCategory()" id="deleteCategoryBtn" style="display: none;">
                                        <i class="fas fa-trash me-1"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Default state -->
                            <div id="categoryDetailsDefault" class="text-center text-muted py-5">
                                <i class="fas fa-mouse-pointer fa-3x mb-3 opacity-50"></i>
                                <h5>Select a Category</h5>
                                <p>Click on a category from the list to view and manage its items</p>
                            </div>

                            <!-- Category details -->
                            <div id="categoryDetailsContent" style="display: none;">
                                <!-- Category info -->
                                <div class="mb-4" id="categoryInfo">
                                    <div class="d-flex align-items-center mb-2">
                                        <i id="categoryIcon" class="fas fa-cogs fa-2x me-3"></i>
                                        <div>
                                            <h4 class="mb-0" id="categoryName">Category Name</h4>
                                            <p class="text-muted mb-0" id="categoryDescription">Category description</p>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2 mt-2" id="categoryBadges">
                                        <!-- Badges will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Category items -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h6 class="mb-0">
                                            <i class="fas fa-tags me-1"></i>Category Items
                                            <span class="badge bg-primary ms-1" id="itemsCount">0</span>
                                        </h6>
                                        <div class="d-flex gap-2">
                                            <input type="text" class="form-control form-control-sm" style="width: 200px;"
                                                   placeholder="Search items..." id="itemSearchInput"
                                                   onkeyup="filterCategoryItems(this.value)">
                                            <button class="btn btn-sm btn-outline-primary" onclick="refreshCategoryItems()">
                                                <i class="fas fa-sync"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Items display -->
                                <div id="categoryItemsContainer">
                                    <div class="text-center text-muted py-3">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                        <p>Loading items...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Industries Tab -->
        <div class="tab-pane fade" id="industries" role="tabpanel">
            <div class="row">
                <!-- Industry Statistics -->
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Industry Statistics
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Total Jobs:</span>
                                    <strong>{{ industry_stats.total_jobs }}</strong>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>With Industry:</span>
                                    <strong class="text-success">{{ industry_stats.jobs_with_industry }}</strong>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between">
                                    <span>Without Industry:</span>
                                    <strong class="text-warning">{{ industry_stats.jobs_without_industry }}</strong>
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar"
                                         style="width: {{ industry_stats.coverage_percentage }}%">
                                        {{ industry_stats.coverage_percentage }}%
                                    </div>
                                </div>
                                <small class="text-muted">Industry Coverage</small>
                            </div>

                            {% if industry_stats.jobs_without_industry > 0 %}
                            <button class="btn btn-info btn-sm w-100" onclick="autoAssignIndustries()">
                                <i class="fas fa-magic me-1"></i>Auto-Assign Industries
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Top Industries -->
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-industry me-2"></i>Industry Breakdown
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if industry_stats.industry_breakdown %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Industry</th>
                                            <th class="text-center">Jobs</th>
                                            <th class="text-center">Usage</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for industry in industry_stats.industry_breakdown %}
                                        <tr>
                                            <td>
                                                <i class="fas fa-industry me-2 text-success"></i>
                                                {{ industry.name }}
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-primary">{{ industry.job_count }}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-info">{{ industry.usage_count }}</span>
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-outline-primary"
                                                        onclick="viewIndustryJobs({{ industry.id }}, '{{ industry.name }}')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-industry fa-3x mb-3"></i>
                                <p>No industry data available. Initialize industries first!</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Blacklist Tab -->
        <div class="tab-pane fade" id="blacklist" role="tabpanel">
            <div class="row">
                <!-- Add to Blacklist Form -->
                <div class="col-lg-4 col-md-5 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-ban me-2"></i>Add to Blacklist
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="addBlacklistForm" onsubmit="addToBlacklistAjax(event)">
                                {{ csrf_token() }}
                                <div class="mb-3">
                                    <label for="skill_text" class="form-label">Skill Text *</label>
                                    <input type="text" class="form-control" id="skill_text" name="skill_text"
                                           placeholder="e.g., Related Industry" required>
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="mb-3">
                                    <label for="reason" class="form-label">Reason (Optional)</label>
                                    <textarea class="form-control" id="reason" name="reason" rows="3"
                                              placeholder="Why this should be blacklisted..."></textarea>
                                    <div class="form-text">Help others understand why this isn't a valid skill</div>
                                </div>
                                <div class="mb-3">
                                    <label for="created_by" class="form-label">Added By (Optional)</label>
                                    <input type="text" class="form-control" id="created_by" name="created_by"
                                           placeholder="Your name or identifier">
                                </div>
                                <button type="submit" class="btn btn-danger w-100" id="addBlacklistBtn">
                                    <i class="fas fa-ban me-1"></i>Add to Blacklist
                                    <span class="loading-spinner spinner-border spinner-border-sm ms-2" role="status"></span>
                                </button>
                            </form>

                            <!-- Quick Add Suggestions -->
                            <div class="mt-3">
                                <h6 class="text-muted">Quick Add Common Non-Skills:</h6>
                                <div class="d-flex flex-wrap gap-1">
                                    <button class="btn btn-sm btn-outline-danger" onclick="quickAddToBlacklist('experience')">experience</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="quickAddToBlacklist('background')">background</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="quickAddToBlacklist('knowledge')">knowledge</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="quickAddToBlacklist('skills')">skills</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8 col-md-7">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-list me-2"></i>Current Blacklisted Skills
                                    <span class="badge bg-danger ms-2" id="blacklistCount">{{ blacklisted_skills|length }}</span>
                                </h5>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control form-control-sm" style="width: 200px;"
                                           placeholder="Search blacklist..."
                                           onkeyup="filterBlacklist(this.value)">
                                    <button class="btn btn-sm btn-outline-primary" onclick="exportBlacklist()">
                                        <i class="fas fa-download"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if blacklisted_skills %}
                                <div class="table-responsive">
                                    <table class="table table-hover" id="blacklistTable">
                                        <thead>
                                            <tr>
                                                <th>Skill</th>
                                                <th>Reason</th>
                                                <th>Added By</th>
                                                <th>Date Added</th>
                                                <th class="text-center">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for skill in blacklisted_skills %}
                                            <tr data-skill-text="{{ skill.skill_text|lower }}" id="blacklist-row-{{ skill.id }}">
                                                <td>
                                                    <strong>{{ skill.skill_text }}</strong>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {{ skill.reason or 'No reason provided' }}
                                                    </small>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {{ skill.created_by or 'Unknown' }}
                                                    </small>
                                                </td>
                                                <td>
                                                    <small class="text-muted">
                                                        {{ skill.created_at.strftime('%Y-%m-%d %H:%M') if skill.created_at else 'Unknown' }}
                                                    </small>
                                                </td>
                                                <td class="text-center">
                                                    <button class="btn btn-sm btn-outline-success me-1"
                                                            onclick="removeFromBlacklistAjax({{ skill.id }}, '{{ skill.skill_text }}')"
                                                            title="Remove from blacklist">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info"
                                                            onclick="editBlacklistEntry({{ skill.id }}, '{{ skill.skill_text }}', '{{ skill.reason or '' }}')"
                                                            title="Edit entry">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Bulk Actions -->
                                <div class="mt-3 border-top pt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <input type="checkbox" id="selectAllBlacklist" onchange="toggleAllBlacklist()">
                                            <label for="selectAllBlacklist" class="ms-2">Select All</label>
                                        </div>
                                        <div>
                                            <button class="btn btn-sm btn-outline-danger" onclick="bulkRemoveFromBlacklist()" disabled id="bulkRemoveBtn">
                                                <i class="fas fa-trash me-1"></i>Remove Selected
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-list fa-3x mb-3 opacity-50"></i>
                                    <h5>No skills are currently blacklisted</h5>
                                    <p>Add skills that should be filtered out from job descriptions</p>
                                    <button class="btn btn-outline-primary" onclick="showCommonBlacklistSuggestions()">
                                        <i class="fas fa-lightbulb me-1"></i>Show Common Suggestions
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Suggestions Tab -->
        <div class="tab-pane fade" id="suggestions" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>Suggested Skills to Review
                                <span class="badge bg-warning ms-2">{{ suggestions|length }}</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if suggestions %}
                                <div class="table-responsive">
                                    <table class="table table-hover" id="suggestionsTable">
                                        <thead>
                                            <tr>
                                                <th>Skill</th>
                                                <th>Reason</th>
                                                <th>Frequency</th>
                                                <th>Example Job</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for suggestion in suggestions %}
                                            <tr id="suggestion-{{ loop.index }}">
                                                <td>
                                                    <strong>{{ suggestion.skill }}</strong>
                                                </td>
                                                <td>
                                                    <small class="text-muted">{{ suggestion.reason }}</small>
                                                </td>
                                                <td>
                                                    <span class="badge bg-info">{{ suggestion.frequency }}</span>
                                                </td>
                                                <td>
                                                    <small>
                                                        <strong>{{ suggestion.company }}</strong><br>
                                                        {{ suggestion.job_title }}
                                                    </small>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-danger me-1"
                                                            onclick="addSuggestionToBlacklist('{{ suggestion.skill }}', '{{ suggestion.reason }}', {{ loop.index }})">
                                                        <i class="fas fa-ban me-1"></i>Blacklist
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-secondary"
                                                            onclick="dismissSuggestion({{ loop.index }})">
                                                        <i class="fas fa-times me-1"></i>Dismiss
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-check-circle fa-3x mb-3"></i>
                                    <p>No suspicious skills found! Your skill extraction is working well.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Category Modal -->
    <div class="modal fade" id="createCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createCategoryForm">
                        <div class="mb-3">
                            <label for="categoryName" class="form-label">Category Name</label>
                            <input type="text" class="form-control" id="categoryName" required>
                        </div>
                        <div class="mb-3">
                            <label for="categoryType" class="form-label">Category Type</label>
                            <select class="form-select" id="categoryType" required>
                                <option value="">Select type...</option>
                                {% for cat_type in category_types %}
                                <option value="{{ cat_type.value }}">{{ cat_type.value|title }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="categoryDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="categoryDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="categoryColor" class="form-label">Color</label>
                                <input type="color" class="form-control form-control-color" id="categoryColor" value="#6c757d">
                            </div>
                            <div class="col-md-6">
                                <label for="categoryIcon" class="form-label">Icon Class</label>
                                <input type="text" class="form-control" id="categoryIcon" placeholder="fas fa-tag">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createCategory()">Create Category</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Category Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addItemModalTitle">Add Item to Category</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addItemForm">
                        <input type="hidden" id="itemCategoryId">
                        <div class="mb-3">
                            <label for="itemName" class="form-label">Item Name</label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="mb-3">
                            <label for="itemDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="itemDescription" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="itemKeywords" class="form-label">Keywords (comma-separated)</label>
                            <input type="text" class="form-control" id="itemKeywords"
                                   placeholder="keyword1, keyword2, keyword3">
                            <div class="form-text">Keywords help with automatic matching and categorization</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCategoryItem()">Add Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Category Items Modal -->
    <div class="modal fade" id="viewItemsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewItemsModalTitle">Category Items</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="categoryItemsContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Enhanced Skills Management JavaScript

function createCategory() {
    const name = document.getElementById('categoryName').value;
    const type = document.getElementById('categoryType').value;
    const description = document.getElementById('categoryDescription').value;
    const color = document.getElementById('categoryColor').value;
    const icon = document.getElementById('categoryIcon').value;

    if (!name || !type) {
        showAlert('danger', 'Please fill in all required fields');
        return;
    }

    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (!csrfToken) {
        showAlert('danger', 'Security token not found. Please refresh the page.');
        return;
    }

    fetch("{{ url_for('skills.create_category') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.getAttribute('content')
        },
        body: JSON.stringify({
            name: name,
            category_type: type,
            description: description,
            color: color,
            icon: icon
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Category created successfully');
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('danger', data.error || 'Failed to create category');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while creating the category');
    });
}

function addItemToCategory(categoryId, categoryName) {
    document.getElementById('itemCategoryId').value = categoryId;
    document.getElementById('addItemModalTitle').textContent = `Add Item to ${categoryName}`;

    // Clear form
    document.getElementById('itemName').value = '';
    document.getElementById('itemDescription').value = '';
    document.getElementById('itemKeywords').value = '';

    new bootstrap.Modal(document.getElementById('addItemModal')).show();
}

function addCategoryItem() {
    const categoryId = document.getElementById('itemCategoryId').value;
    const name = document.getElementById('itemName').value;
    const description = document.getElementById('itemDescription').value;
    const keywords = document.getElementById('itemKeywords').value;

    if (!name) {
        showAlert('danger', 'Please enter an item name');
        return;
    }

    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (!csrfToken) {
        showAlert('danger', 'Security token not found. Please refresh the page.');
        return;
    }

    fetch(`{{ url_for('skills.create_category_item', category_id=0) }}`.replace('0', categoryId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.getAttribute('content')
        },
        body: JSON.stringify({
            name: name,
            description: description,
            keywords: keywords
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', 'Item added successfully');
            bootstrap.Modal.getInstance(document.getElementById('addItemModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showAlert('danger', data.error || 'Failed to add item');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while adding the item');
    });
}

function viewCategoryItems(categoryId, categoryName) {
    document.getElementById('viewItemsModalTitle').textContent = `${categoryName} Items`;
    document.getElementById('categoryItemsContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    `;

    new bootstrap.Modal(document.getElementById('viewItemsModal')).show();

    fetch(`{{ url_for('skills.get_category_items', category_id=0) }}`.replace('0', categoryId))
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let html = '';
            if (data.items.length > 0) {
                html = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Keywords</th>
                                    <th>Usage</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                data.items.forEach(item => {
                    html += `
                        <tr>
                            <td><strong>${item.name}</strong></td>
                            <td><small class="text-muted">${item.description || 'No description'}</small></td>
                            <td>
                                ${item.keywords.map(k => `<span class="badge bg-light text-dark me-1">${k}</span>`).join('')}
                            </td>
                            <td><span class="badge bg-info">${item.usage_count}</span></td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
            } else {
                html = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No items in this category yet.</p>
                    </div>
                `;
            }

            document.getElementById('categoryItemsContent').innerHTML = html;
        } else {
            document.getElementById('categoryItemsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed to load category items: ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('categoryItemsContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                An error occurred while loading category items.
            </div>
        `;
    });
}

function autoAssignIndustries() {
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (!csrfToken) {
        showAlert('danger', 'Security token not found. Please refresh the page.');
        return;
    }

    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
    button.disabled = true;

    fetch("{{ url_for('skills.auto_assign_industries') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.getAttribute('content')
        },
        body: JSON.stringify({
            limit: 50
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('danger', data.error || 'Failed to auto-assign industries');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while auto-assigning industries');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Duplicate function removed - using enhanced version below

function dismissSuggestion(index) {
    const row = document.getElementById('suggestion-' + index);
    if (row) {
        row.style.transition = 'opacity 0.3s';
        row.style.opacity = '0';
        setTimeout(() => row.remove(), 300);
    }
}

// Enhanced Alert System
function showAlert(type, message, duration = 5000) {
    const alertContainer = document.getElementById('alertContainer');
    const alertId = 'alert-' + Date.now();

    const alertDiv = document.createElement('div');
    alertDiv.id = alertId;
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${getAlertIcon(type)} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    alertContainer.appendChild(alertDiv);

    // Auto-dismiss
    setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) {
            alert.remove();
        }
    }, duration);
}

function getAlertIcon(type) {
    const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-triangle',
        'warning': 'exclamation-circle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

// Enhanced Blacklist Functions
function addToBlacklistAjax(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const submitBtn = document.getElementById('addBlacklistBtn');
    const spinner = submitBtn.querySelector('.loading-spinner');

    // Show loading state
    submitBtn.disabled = true;
    spinner.style.display = 'inline-block';

    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (!csrfToken) {
        showAlert('danger', 'Security token not found. Please refresh the page.');
        resetButton(submitBtn, spinner);
        return;
    }

    fetch("{{ url_for('skills.add_to_blacklist_ajax') }}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken.getAttribute('content')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.success) {
            showAlert('success', data.message || 'Skill added to blacklist successfully');
            form.reset();
            updateBlacklistCount();
            // Optionally reload the blacklist table
            setTimeout(() => location.reload(), 1000);
        } else if (data) {
            showAlert('danger', data.error || 'Failed to add skill to blacklist');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while adding the skill to blacklist');
    })
    .finally(() => {
        resetButton(submitBtn, spinner);
    });
}

function removeFromBlacklistAjax(skillId, skillText) {
    if (!confirm(`Remove "${skillText}" from blacklist?`)) {
        return;
    }

    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (!csrfToken) {
        showAlert('danger', 'Security token not found. Please refresh the page.');
        return;
    }

    fetch(`{{ url_for('skills.remove_from_blacklist', skill_id=0) }}`.replace('0', skillId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken.getAttribute('content')
        }
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;
            return;
        }
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            showAlert('success', data.message || 'Skill removed from blacklist successfully');
            // Remove row with animation
            const row = document.getElementById(`blacklist-row-${skillId}`);
            if (row) {
                row.style.transition = 'opacity 0.3s ease';
                row.style.opacity = '0';
                setTimeout(() => {
                    row.remove();
                    updateBlacklistCount();
                }, 300);
            }
        } else if (data) {
            showAlert('danger', data.error || 'Failed to remove skill from blacklist');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while removing the skill from blacklist');
    });
}

function quickAddToBlacklist(skillText) {
    document.getElementById('skill_text').value = skillText;
    document.getElementById('reason').value = `Common non-skill term: ${skillText}`;
    document.getElementById('skill_text').focus();
}

// Utility Functions
function resetButton(button, spinner) {
    button.disabled = false;
    if (spinner) {
        spinner.style.display = 'none';
    }
}

function updateBlacklistCount() {
    const rows = document.querySelectorAll('#blacklistTable tbody tr:not([style*="display: none"])');
    const countElement = document.getElementById('blacklistCount');
    if (countElement) {
        countElement.textContent = rows.length;
    }
}

function filterBlacklist(searchTerm) {
    const rows = document.querySelectorAll('#blacklistTable tbody tr');
    const term = searchTerm.toLowerCase();

    rows.forEach(row => {
        const skillText = row.getAttribute('data-skill-text') || '';
        const visible = skillText.includes(term) ||
                       row.textContent.toLowerCase().includes(term);
        row.style.display = visible ? '' : 'none';
    });

    updateBlacklistCount();
}

// Enhanced category management functions
let selectedCategoryId = null;
let selectedCategoryType = null;

function selectCategory(categoryId, categoryType) {
    selectedCategoryId = categoryId;
    selectedCategoryType = categoryType;

    // Update UI to show selected state
    document.querySelectorAll('.category-list-item').forEach(item => {
        item.classList.remove('active');
    });

    const selectedItem = document.querySelector(`[data-category-id="${categoryId}"]`);
    if (selectedItem) {
        selectedItem.classList.add('active');
    }

    // Load category details
    loadCategoryDetails(categoryId, categoryType);
}

function loadCategoryDetails(categoryId, categoryType) {
    // Show loading state
    document.getElementById('categoryDetailsDefault').style.display = 'none';
    document.getElementById('categoryDetailsContent').style.display = 'block';
    document.getElementById('categoryActions').style.display = 'block';

    // Load category items
    fetch(`/skills/categories/${categoryId}/items`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCategoryDetails(data.category, data.items);
            } else {
                showAlert('danger', 'Failed to load category details');
            }
        })
        .catch(error => {
            console.error('Error loading category details:', error);
            showAlert('danger', 'Error loading category details');
        });
}

function displayCategoryDetails(category, items) {
    // Update category info
    document.getElementById('categoryDetailsTitle').innerHTML =
        `<i class="${category.icon} me-2"></i>${category.name}`;
    document.getElementById('categoryIcon').className = `${category.icon} fa-2x me-3`;
    document.getElementById('categoryIcon').style.color = category.color;
    document.getElementById('categoryName').textContent = category.name;
    document.getElementById('categoryDescription').textContent = category.description || 'No description';
    document.getElementById('itemsCount').textContent = items.length;

    // Update badges
    const badgesContainer = document.getElementById('categoryBadges');
    badgesContainer.innerHTML = '';

    const typeBadge = document.createElement('span');
    typeBadge.className = 'badge bg-primary';
    typeBadge.textContent = category.category_type.charAt(0).toUpperCase() + category.category_type.slice(1);
    badgesContainer.appendChild(typeBadge);

    if (category.is_system) {
        const systemBadge = document.createElement('span');
        systemBadge.className = 'badge bg-secondary';
        systemBadge.textContent = 'System';
        badgesContainer.appendChild(systemBadge);
    }

    const itemsBadge = document.createElement('span');
    itemsBadge.className = 'badge bg-info';
    itemsBadge.textContent = `${items.length} items`;
    badgesContainer.appendChild(itemsBadge);

    // Show/hide delete button based on system status
    const deleteBtn = document.getElementById('deleteCategoryBtn');
    deleteBtn.style.display = category.is_system ? 'none' : 'inline-block';

    // Display items
    displayCategoryItems(items);
}

function displayCategoryItems(items) {
    const container = document.getElementById('categoryItemsContainer');

    if (items.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-tags fa-3x mb-3 opacity-50"></i>
                <h5>No Items</h5>
                <p>This category doesn't have any items yet.</p>
                <button class="btn btn-primary" onclick="addItemToSelectedCategory()">
                    <i class="fas fa-plus me-1"></i>Add First Item
                </button>
            </div>
        `;
        return;
    }

    let html = '<div class="row">';
    items.forEach(item => {
        const isActive = item.is_active !== false;
        html += `
            <div class="col-md-6 col-lg-4 mb-3 category-item-card" data-item-name="${item.name.toLowerCase()}">
                <div class="card ${isActive ? '' : 'opacity-50'}">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title mb-0">${item.name}</h6>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editCategoryItem(${item.id})">
                                        <i class="fas fa-edit me-2"></i>Edit
                                    </a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteCategoryItem(${item.id}, '${item.name}')">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        ${item.description ? `<p class="card-text small text-muted mb-2">${item.description}</p>` : ''}
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-1 flex-wrap">
                                ${item.keywords && item.keywords.length > 0 ?
                                    item.keywords.slice(0, 3).map(keyword =>
                                        `<span class="badge bg-light text-dark">${keyword}</span>`
                                    ).join('') :
                                    '<span class="badge bg-light text-muted">No keywords</span>'
                                }
                                ${item.keywords && item.keywords.length > 3 ?
                                    `<span class="badge bg-light text-muted">+${item.keywords.length - 3}</span>` : ''
                                }
                            </div>
                            ${item.usage_count > 0 ?
                                `<span class="badge bg-success">${item.usage_count} uses</span>` :
                                '<span class="badge bg-secondary">0 uses</span>'
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    container.innerHTML = html;
}

function filterCategoriesList(searchTerm) {
    const items = document.querySelectorAll('.category-list-item');
    const term = searchTerm.toLowerCase();

    items.forEach(item => {
        const categoryName = item.getAttribute('data-category-name') || '';
        const visible = categoryName.includes(term) ||
                       item.textContent.toLowerCase().includes(term);
        item.style.display = visible ? '' : 'none';
    });
}

function filterCategoryItems(searchTerm) {
    const items = document.querySelectorAll('.category-item-card');
    const term = searchTerm.toLowerCase();

    items.forEach(item => {
        const itemName = item.getAttribute('data-item-name') || '';
        const visible = itemName.includes(term) ||
                       item.textContent.toLowerCase().includes(term);
        item.style.display = visible ? '' : 'none';
    });
}

function refreshCategoryItems() {
    if (selectedCategoryId) {
        loadCategoryDetails(selectedCategoryId, selectedCategoryType);
    }
}

function editSelectedCategory() {
    if (selectedCategoryId) {
        editCategory(selectedCategoryId);
    }
}

function addItemToSelectedCategory() {
    if (selectedCategoryId) {
        addItemToCategory(selectedCategoryId, document.getElementById('categoryName').textContent);
    }
}

function deleteSelectedCategory() {
    if (selectedCategoryId) {
        const categoryName = document.getElementById('categoryName').textContent;
        deleteCategory(selectedCategoryId, categoryName);
    }
}

function filterCategories(searchTerm, containerId) {
    const container = document.getElementById(containerId);
    const categories = container.querySelectorAll('.category-item');
    const term = searchTerm.toLowerCase();

    categories.forEach(category => {
        const categoryName = category.getAttribute('data-category-name') || '';
        const visible = categoryName.includes(term) ||
                       category.textContent.toLowerCase().includes(term);
        category.style.display = visible ? '' : 'none';
    });
}

// Enhanced suggestion functions
function addSuggestionToBlacklist(skillText, reason, index) {
    const button = document.querySelector(`#suggestion-${index} .btn-danger`);
    const spinner = button.querySelector('.loading-spinner');

    if (!spinner) {
        button.innerHTML += '<span class="loading-spinner spinner-border spinner-border-sm ms-2" role="status"></span>';
    }

    button.disabled = true;
    button.querySelector('.loading-spinner').style.display = 'inline-block';

    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (!csrfToken) {
        showAlert('danger', 'Security token not found. Please refresh the page.');
        resetSuggestionButton(button);
        return;
    }

    fetch("{{ url_for('skills.add_suggestion_to_blacklist') }}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken.getAttribute('content')
        },
        body: JSON.stringify({
            skill_text: skillText,
            reason: reason
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the suggestion row with animation
            const row = document.getElementById('suggestion-' + index);
            if (row) {
                row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                row.style.opacity = '0';
                row.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    row.remove();
                    updateSuggestionCount();
                }, 300);
            }

            showAlert('success', data.message || 'Skill added to blacklist successfully');
            updateBlacklistCount();
        } else {
            showAlert('danger', data.error || 'Failed to add skill to blacklist');
            resetSuggestionButton(button);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('danger', 'An error occurred while adding the skill to blacklist');
        resetSuggestionButton(button);
    });
}

function resetSuggestionButton(button) {
    button.disabled = false;
    const spinner = button.querySelector('.loading-spinner');
    if (spinner) {
        spinner.style.display = 'none';
    }
}

function updateSuggestionCount() {
    const rows = document.querySelectorAll('#suggestionsTable tbody tr:not([style*="display: none"])');
    const badge = document.querySelector('#suggestions-tab .badge');
    if (badge) {
        badge.textContent = rows.length;
        if (rows.length === 0) {
            badge.style.display = 'none';
        }
    }
}

function refreshSuggestions() {
    const button = document.getElementById('refreshSuggestionsBtn');
    const spinner = button.querySelector('.loading-spinner');

    button.disabled = true;
    spinner.style.display = 'inline-block';

    // Reload the page to refresh suggestions
    setTimeout(() => {
        location.reload();
    }, 500);
}

function exportBlacklist() {
    const rows = document.querySelectorAll('#blacklistTable tbody tr');
    const data = [];

    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 4) {
            data.push({
                skill: cells[0].textContent.trim(),
                reason: cells[1].textContent.trim(),
                addedBy: cells[2].textContent.trim(),
                dateAdded: cells[3].textContent.trim()
            });
        }
    });

    const csv = convertToCSV(data);
    downloadCSV(csv, 'skill_blacklist.csv');
}

function convertToCSV(data) {
    const headers = ['Skill', 'Reason', 'Added By', 'Date Added'];
    const csvContent = [
        headers.join(','),
        ...data.map(row => [
            `"${row.skill}"`,
            `"${row.reason}"`,
            `"${row.addedBy}"`,
            `"${row.dateAdded}"`
        ].join(','))
    ].join('\n');

    return csvContent;
}

function downloadCSV(csv, filename) {
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
