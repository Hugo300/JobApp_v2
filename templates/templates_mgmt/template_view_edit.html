{% extends "base.html" %}

{% block title %}{{ template.name }} - Template Editor{% endblock %}

{% block head %}
<!-- Prism.js for LaTeX syntax highlighting -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet" />
<style>
    .code-editor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.4;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    .code-editor:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .file-tab {
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .file-tab.active {
        border-bottom-color: #0d6efd;
        background-color: #f8f9fa;
    }
    
    .section-item {
        transition: all 0.2s ease;
    }
    
    .section-item:hover {
        background-color: #f8f9fa;
    }
    
    .preview-panel {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        min-height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('templates.landing') }}">
                                    <i class="fas fa-file-alt me-1"></i>Templates
                                </a>
                            </li>
                            <li class="breadcrumb-item active">{{ template.name }}</li>
                        </ol>
                    </nav>
                    <h1>
                        <i class="fas fa-edit me-2"></i>{{ template.name }}
                        <span class="badge bg-{{ 'info' if template.template_type == 'file' else 'secondary' }} ms-2">
                            {{ template.template_type|title }}
                        </span>
                    </h1>
                </div>
                <div>
                    <a href="{{ url_for('templates.landing') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Templates
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- File Tabs (for file-based templates) -->
        {% if template.template_type == 'file' %}
        <div class="col-12 mb-3">
            <ul class="nav nav-tabs" id="fileTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active file-tab" id="main-tab" data-bs-toggle="tab" 
                            data-bs-target="#main-content" type="button" role="tab">
                        <i class="fas fa-file-alt me-2"></i>Main File
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link file-tab" id="sections-tab" data-bs-toggle="tab" 
                            data-bs-target="#sections-content" type="button" role="tab">
                        <i class="fas fa-folder me-2"></i>Sections
                    </button>
                </li>
            </ul>
        </div>
        {% endif %}

        <!-- Main File Content -->
        <div class="col-12">
            <div class="tab-content" id="fileTabContent">
                <!-- Main File Tab -->
                <div class="tab-pane fade show active" id="main-content" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-file-alt me-2"></i>Main Template File
                                </h5>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="saveMainFile()" {{ 'disabled' if read_only else '' }}>
                                        <i class="fas fa-save me-1"></i>Save
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="previewMainFile()">
                                        <i class="fas fa-eye me-1"></i>Preview
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <textarea id="mainFileEditor" class="form-control code-editor" rows="25" 
                                      placeholder="Enter LaTeX content here..." 
                                      {{ 'readonly' if read_only else '' }}>{{ main_content }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- Sections Tab (for file-based templates) -->
                {% if template.template_type == 'file' %}
                <div class="tab-pane fade" id="sections-content" role="tabpanel">
                    <div class="row">
                        <!-- Sections List -->
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-folder me-2"></i>Sections
                                        </h5>
                                        <button class="btn btn-outline-success btn-sm" onclick="showUploadSection()" {{ 'disabled' if read_only else '' }}>
                                            <i class="fas fa-plus me-1"></i>Add Section
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="sectionsList" class="list-group">
                                        <!-- Sections will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section Editor -->
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">
                                            <i class="fas fa-edit me-2"></i>Section Editor
                                            <span id="currentSectionName" class="text-muted"></span>
                                        </h5>
                                        <div id="sectionActions" style="display: none;">
                                            <button class="btn btn-outline-primary btn-sm" onclick="saveSection()" {{ 'disabled' if read_only else '' }}>
                                                <i class="fas fa-save me-1"></i>Save
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteCurrentSection()" {{ 'disabled' if read_only else '' }}>
                                                <i class="fas fa-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <textarea id="sectionEditor" class="form-control code-editor" rows="25" 
                                              placeholder="Select a section to edit..." 
                                              {{ 'readonly' if read_only else 'disabled' }}></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Upload Section Modal -->
<div class="modal fade" id="uploadSectionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Section File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadSectionForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="sectionFile" class="form-label">Select LaTeX Section File</label>
                        <input type="file" class="form-control" id="sectionFile" name="file" accept=".tex,.sty,.cls,.bib" required>
                        <div class="form-text">Allowed file types: .tex, .sty, .cls, .bib</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadSection()">Upload Section</button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">LaTeX Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre><code class="language-latex" id="previewContent"></code></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Prism.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-clike.min.js"></script>

<script>
// Configure Prism for LaTeX
Prism.languages.latex = {
    'comment': /%.*$/m,
    'keyword': /\\[a-zA-Z]+/,
    'string': /\{[^}]*\}/,
    'number': /\b\d+\b/,
    'operator': /[{}[\]]/,
    'punctuation': /[\\{}[\]]/
};

let currentSection = null;
let currentTemplateName = '{{ template.name }}';

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    if ('{{ template.template_type }}' === 'file') {
        loadSections();
    }
});

function loadSections() {
    fetch(`/templates/list_sections/${currentTemplateName}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('sectionsList');
            if (data.sections && data.sections.length > 0) {
                let html = '';
                data.sections.forEach(section => {
                    html += `
                        <div class="list-group-item section-item" onclick="loadSection('${section.name}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${section.name}</strong>
                                    <br><small class="text-muted">${section.filename}</small>
                                </div>
                                <i class="fas fa-chevron-right text-muted"></i>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-muted text-center py-3">No sections found.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading sections');
        });
}

function loadSection(sectionName) {
    currentSection = sectionName;
    document.getElementById('currentSectionName').textContent = `- ${sectionName}`;
    document.getElementById('sectionActions').style.display = 'block';
    document.getElementById('sectionEditor').disabled = false;
    
    fetch(`/templates/section/${currentTemplateName}/${sectionName}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                document.getElementById('sectionEditor').value = data.content;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading section');
        });
}

function saveMainFile() {
    const content = document.getElementById('mainFileEditor').value;
    
    const formData = new FormData();
    formData.append('content', content);
    
    fetch(`/templates/main_file/${currentTemplateName}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Main file saved successfully!', 'success');
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error saving main file', 'danger');
    });
}

function saveSection() {
    if (!currentSection) {
        showAlert('Please select a section first', 'warning');
        return;
    }
    
    const content = document.getElementById('sectionEditor').value;
    
    const formData = new FormData();
    formData.append('content', content);
    
    fetch(`/templates/section/${currentTemplateName}/${currentSection}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Section saved successfully!', 'success');
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error saving section', 'danger');
    });
}

function deleteCurrentSection() {
    if (!currentSection) {
        showAlert('Please select a section first', 'warning');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete section "${currentSection}"?`)) {
        return;
    }
    
    fetch(`/templates/delete_section/${currentTemplateName}/${currentSection}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Section deleted successfully!', 'success');
            currentSection = null;
            document.getElementById('currentSectionName').textContent = '';
            document.getElementById('sectionActions').style.display = 'none';
            document.getElementById('sectionEditor').value = '';
            document.getElementById('sectionEditor').disabled = true;
            loadSections();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error deleting section', 'danger');
    });
}

function showUploadSection() {
    const modal = new bootstrap.Modal(document.getElementById('uploadSectionModal'));
    modal.show();
}

function uploadSection() {
    const fileInput = document.getElementById('sectionFile');
    if (!fileInput.files[0]) {
        showAlert('Please select a file', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('template_name', currentTemplateName);
    
    fetch('/templates/upload_section', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Section uploaded successfully!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadSectionModal'));
            modal.hide();
            fileInput.value = '';
            loadSections();
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error uploading section', 'danger');
    });
}

function previewMainFile() {
    const content = document.getElementById('mainFileEditor').value;
    document.getElementById('previewContent').textContent = content;
    
    // Apply syntax highlighting
    Prism.highlightElement(document.getElementById('previewContent'));
    
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

function showAlert(message, type) {
    // Create a temporary alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
