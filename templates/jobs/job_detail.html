{% extends "base.html" %}

{% block title %}{{ job.title }} at {{ job.company }} - Job Application Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-briefcase-fill me-2"></i>{{ job.title }}</h1>
                <p class="text-muted mb-1">
                    <i class="bi bi-building-fill me-1"></i>{{ job.company }}
                    {% if job.url %}
                        <a href="{{ job.url }}" target="_blank" class="ms-2">
                            <i class="bi bi-link-45deg"></i>View Original
                        </a>
                    {% endif %}
                </p>
                {% if job.office_location or job.country or job.job_mode %}
                <p class="text-muted mb-0">
                    {% if job.office_location %}
                        <i class="bi bi-geo-alt-fill me-1"></i>{{ job.office_location }}
                        {% if job.country %}, {{ job.country }}{% endif %}
                    {% elif job.country %}
                        <i class="bi bi-globe me-1"></i>{{ job.country }}
                    {% endif %}
                    {% if job.job_mode %}
                        <span class="ms-3">
                            <i class="bi bi-laptop me-1"></i>{{ job.job_mode }}
                        </span>
                    {% endif %}
                    {% if job.industry %}
                        <span class="ms-3">
                            <i class="bi bi-buildings-fill me-1"></i>{{ job.industry.name }}
                        </span>
                    {% endif %}
                </p>
                {% endif %}
            </div>
            <div class="d-flex gap-2">
                <a href="{{ url_for('jobs.edit_job', job_id=job.id) }}" class="btn btn-primary">
                    <i class="bi bi-pencil-fill me-1"></i>
                    Edit
                </a>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="bi bi-trash me-1"></i>
                    Delete
                </button>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>
                    Back
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Job Details and Analysis -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-text-paragraph"></i> Job Description
                        </h5>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#jobDescriptionCollapse" aria-expanded="false" aria-controls="jobDescriptionCollapse" id="descriptionToggleBtn">
                        <i class="bi bi-chevron-down" id="descriptionToggleIcon"></i>
                    </button>
                </div>
            </div>

            <!-- Collapsed preview (shown when collapsed) -->
            <div class="collapse show" id="jobDescriptionPreview">
                <div class="card-body job-description-preview">
                    {% if job.description %}
                        <div class="job-description-collapsed">
                            {{ job_description[:500] | safe }}{% if job.description|length > 500 %}...{% endif %}
                        </div>
                    {% else %}
                        <p class="text-muted">No description available.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Full description (shown when expanded) -->
            <div class="collapse" id="jobDescriptionCollapse">
                <div class="card-body">
                    {% if job.description %}
                        <div class="job-description">
                            {{ job_description | safe }}
                        </div>
                    {% else %}
                        <p class="text-muted">No description available.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Extracted Skills -->
        {% if job_skills %}
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-gear-fill me-2"></i>Extracted Skills
                        <span class="badge bg-primary ms-2">{{ total_skills }}</span>
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        {% if user_data and user_data.skills %}
                            <div class="skill-match-score">
                                <span class="badge bg-{% if match_score >= 80 %}success{% elif match_score >= 60 %}warning{% else %}danger{% endif %} fs-6">
                                    <i class="bi bi-graph-up me-1"></i>{{ match_score }}% Match
                                </span>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="skills-container">
                {% for category, skills in job_skills.items() %}
                    <div class="skill-category mb-3">
                        <div class="skill-category-title">
                            {{ category }}
                            <span class="skill-count">{{ skills|length }}</span>
                        </div>
                        <div class="skill-category-items">
                            {% for skill in skills %}
                                <span class="badge me-2 mb-2 skill-badge bg-success text-white skill-matched">
                                    <i class="bi bi-check-circle me-1"></i>{{ skill }}
                                </span>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Skills automatically extracted from job description using AI
                    </small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Job Logs -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history me-2"></i> Activity Log
                    </h5>
                    <small class="text-muted">Track all activities and status changes</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-success" type="button" data-bs-toggle="collapse" data-bs-target="#quickLogForm" aria-expanded="false">
                        <i class="bi bi-plus-circle me-1"></i> Quick Log
                    </button>
                    <a href="{{ url_for('jobs.add_log', job_id=job.id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-pencil-fill"></i> Detailed Log
                    </a>
                    {% if total_logs > 10 %}
                        {% if request.args.get('show_all') == 'true' %}
                            <a href="{{ url_for('jobs.job_detail', job_id=job.id) }}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-arrows-angle-contract me-1"></i> Show Recent
                            </a>
                        {% else %}
                            <a href="{{ url_for('jobs.job_detail', job_id=job.id, show_all='true') }}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-arrows-angle-expand me-1"></i> Show All
                            </a>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Quick Log Form (Collapsible) -->
            <div class="collapse" id="quickLogForm">
                <div class="card-body border-bottom">
                    <form method="POST" action="{{ url_for('jobs.quick_log', job_id=job.id) }}" id="quickLogFormElement">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row align-items-end">
                            <div class="col-md-8">
                                <label for="quickNote" class="form-label fw-bold">Quick Note</label>
                                <textarea name="note" id="quickNote" class="form-control" rows="2" placeholder="Add a quick note about this job..." maxlength="500" required></textarea>
                                <div class="form-text">
                                    <span class="float-end">
                                        <span id="quickCharCount">0</span>/500 characters
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-success">
                                        <i class="bi bi-plus-circle me-1"></i> Add
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#quickLogForm">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card-body p-0">
                {% if recent_logs %}
                    <div class="timeline-container">
                        {% for log in recent_logs %}
                        <div class="timeline-item {% if loop.first %}timeline-item-first{% endif %} {% if loop.last %}timeline-item-last{% endif %}">
                            <div class="timeline-marker-container">
                                <div class="timeline-marker {% if log.status_change_from and log.status_change_to %}timeline-marker-status{% else %}timeline-marker-note{% endif %}">
                                    {% if log.status_change_from and log.status_change_to %}
                                        <i class="bi bi-arrow-left-right"></i>
                                    {% else %}
                                        <i class="bi bi-sticky"></i>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="timeline-content">
                                <div class="timeline-header">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="timeline-date">
                                            <strong>{{ log.created_at.strftime('%b %d, %Y') }}</strong>
                                            <span class="text-muted">at {{ log.created_at.strftime('%I:%M %p') }}</span>
                                            <small class="text-muted ms-1 relative-time" title="{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}" data-timestamp="{{ log.created_at.isoformat() }}">
                                                ({{ log.created_at.strftime('%b %d') }})
                                            </small>
                                        </div>
                                        <div class="dropdown ps-2">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" href="{{ url_for('jobs.edit_log', job_id=job.id, log_id=log.id) }}">
                                                        <i class="bi bi-pencil-fill me-2"></i> Edit
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a class="dropdown-item text-danger" href="#" onclick="confirmDeleteLog({{ log.id }}, '{{ log.note[:30]|e }}{% if log.note|length > 30 %}...{% endif %}')">
                                                        <i class="bi bi-trash-fill me-2"></i> Delete
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                    {% if log.status_change_from and log.status_change_to %}
                                        <div class="status-change-badges mt-1">
                                            <span class="badge bg-secondary">{{ log.status_change_from }}</span>
                                            <i class="bi bi-arrow-right mx-1 text-muted"></i>
                                            <span class="badge bg-success">{{ log.status_change_to }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="timeline-note">
                                    {% for paragraph in log.note.split('\n') %}
                                        {% if paragraph.strip() %}
                                            <p class="mb-2">{{ paragraph|e }}</p>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if total_logs > 10 %}
                        <div class="text-center py-3 border-top bg-light">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                {% if request.args.get('show_all') == 'true' %}
                                    Showing all {{ total_logs }} logs
                                {% else %}
                                    Showing 10 most recent logs out of {{ total_logs }} total
                                {% endif %}
                            </small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <div class="mb-3">
                            <i class="bi bi-clipboard2 text-muted"></i>
                        </div>
                        <h6 class="text-muted">No activity logs yet</h6>
                        <p class="text-muted mb-3">Start tracking your job application progress by adding your first log entry.</p>
                        <a href="{{ url_for('jobs.add_log', job_id=job.id) }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle me-1"></i>Add First Log Entry
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- PDF Generation -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Generate Documents</h5>
            </div>
            <div class="card-body">
                {% if not user_data %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Please set up your <a href="{{ url_for('main.user_data') }}">user profile</a> first.
                    </div>
                {% elif not templates %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Please create some <a href="{{ url_for('main.templates') }}">templates</a> first.
                    </div>
                {% else %}
                    <form method="POST" action="{{ url_for('jobs.generate_pdf', job_id=job.id) }}">
                        <div class="mb-3">
                            <label for="template" class="form-label">Template</label>
                            <select class="form-select" id="template" name="template_id" onchange="loadTemplateContent()">
                                <option value="">Select a template...</option>
                                {% for template in templates %}
                                    <option value="{{ template.id }}" data-type="{{ template.template_type }}">
                                        {{ template.name }} ({{ template.template_type|title }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="type" class="form-label">Document Type</label>
                            <select class="form-select" id="type" name="type" required>
                                <option value="CV">CV</option>
                                <option value="Cover Letter">Cover Letter</option>
                            </select>
                        </div>
                        
                        <div class="mb-3" id="content-section">
                            <label for="content" class="form-label">LaTeX Content</label>
                            <textarea class="form-control" id="content" name="content" rows="10" 
                                      placeholder="Select a template to load content..."></textarea>
                            <div class="form-text" id="template-info">
                                Select a template to load its content. File-based templates will automatically include section files.
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-file-earmark-pdf me-1"></i>Generate PDF
                            </button>
                        </div>
                    </form>
                {% endif %}
            </div>
        </div>

        <!-- Generated Documents -->
        {% if job.documents %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Generated Documents</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for document in job.documents|sort(attribute='created_at', reverse=true) %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ document.type }}</h6>
                            <small class="text-muted">{{ document.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        </div>
                        <a href="{{ url_for('jobs.download_document', job_id=job.id, document_id=document.id) }}" 
                           class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-download me-1"></i>Download
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Relative time functionality
function getRelativeTime(timestamp) {
    const now = new Date();
    const date = new Date(timestamp);
    const diffInSeconds = Math.floor((now - date) / 1000);

    if (diffInSeconds < 60) return 'just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
    if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} days ago`;
    if (diffInSeconds < 31536000) return `${Math.floor(diffInSeconds / 2592000)} months ago`;
    return `${Math.floor(diffInSeconds / 31536000)} years ago`;
}

// Update relative times on page load
document.addEventListener('DOMContentLoaded', function() {
    const relativeTimeElements = document.querySelectorAll('.relative-time');
    relativeTimeElements.forEach(element => {
        const timestamp = element.getAttribute('data-timestamp');
        if (timestamp) {
            element.textContent = `(${getRelativeTime(timestamp)})`;
        }
    });

    // Quick log character count
    const quickNote = document.getElementById('quickNote');
    const quickCharCount = document.getElementById('quickCharCount');

    if (quickNote && quickCharCount) {
        quickNote.addEventListener('input', function() {
            const currentLength = quickNote.value.length;
            quickCharCount.textContent = currentLength;

            if (currentLength > 400) {
                quickCharCount.className = 'text-warning';
            } else if (currentLength > 475) {
                quickCharCount.className = 'text-danger';
            } else {
                quickCharCount.className = '';
            }
        });

        // Initialize count
        quickCharCount.textContent = quickNote.value.length;
    }

    // Job description collapse toggle
    const descriptionCollapse = document.getElementById('jobDescriptionCollapse');
    const descriptionToggleIcon = document.getElementById('descriptionToggleIcon');
    const descriptionPreview = document.getElementById('descriptionPreview');

    if (descriptionCollapse && descriptionToggleIcon) {
        descriptionCollapse.addEventListener('show.bs.collapse', function() {
            // When expanding
            descriptionToggleIcon.className = 'bi bi-chevron-up';
            if (descriptionPreview) {
                descriptionPreview.classList.remove('show');
            }
        });

        descriptionCollapse.addEventListener('hide.bs.collapse', function() {
            // When collapsing
            descriptionToggleIcon.className = 'bi bi-chevron-down';
            if (descriptionPreview) {
                descriptionPreview.classList.add('show');
            }
        });
    }
});



function loadTemplateContent() {
    const templateSelect = document.getElementById('template');
    const templateId = templateSelect.value;
    const contentTextarea = document.getElementById('content');
    const templateInfo = document.getElementById('template-info');
    
    if (!templateId) {
        contentTextarea.value = '';
        templateInfo.textContent = 'Select a template to load its content. File-based templates will automatically include section files.';
        return;
    }
    
    // Get the selected option to check template type
    const selectedOption = templateSelect.options[templateSelect.selectedIndex];
    const templateType = selectedOption.getAttribute('data-type');
    
    fetch(`/templates/${templateId}`)
        .then(response => response.json())
        .then(data => {
            contentTextarea.value = data.content;
            
            if (templateType === 'file') {
                templateInfo.innerHTML = `
                    <strong>File-based template loaded!</strong><br>
                    This template includes section files and will be compiled with all associated files (sections/, styles/, etc.).
                    <br><small class="text-muted">You can edit the content above, but section files are managed separately.</small>
                `;
            } else {
                templateInfo.textContent = 'Database template content loaded. You can edit the content above.';
            }
        })
        .catch(error => {
            console.error('Error loading template:', error);
            alert('Error loading template content');
            templateInfo.textContent = 'Error loading template content.';
        });
}

// Toggle description collapse icon and preview/full view
document.addEventListener('DOMContentLoaded', function() {
    const collapseElement = document.getElementById('jobDescriptionCollapse');
    const previewElement = document.getElementById('jobDescriptionPreview');
    const toggleIcon = document.getElementById('descriptionToggleIcon');

    if (collapseElement && toggleIcon && previewElement) {
        // Handle expand/collapse
        collapseElement.addEventListener('show.bs.collapse', function () {
            toggleIcon.classList.remove('bi-chevron-down');
            toggleIcon.classList.add('bi-chevron-up');
            previewElement.classList.remove('show');
        });

        collapseElement.addEventListener('hide.bs.collapse', function () {
            toggleIcon.classList.remove('bi-chevron-up');
            toggleIcon.classList.add('bi-chevron-down');
            previewElement.classList.add('show');
        });

        // Make preview clickable to expand
        const previewCard = document.querySelector('.job-description-preview');
        if (previewCard) {
            previewCard.addEventListener('click', function() {
                const collapse = new bootstrap.Collapse(collapseElement, {
                    show: true
                });
            });
        }
    }
});

// Delete confirmation functionality
function confirmDelete() {
    const jobTitle = "{{ job.title }}";
    const jobCompany = "{{ job.company }}";

    if (confirm(`Are you sure you want to delete the job application "${jobTitle}" at ${jobCompany}?\n\nThis action cannot be undone and will also delete:\n• All log entries\n• All generated documents\n• All associated data`)) {
        // Create and submit delete form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('jobs.delete_job', job_id=job.id) }}";

        // Add CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}

// Log delete confirmation functionality
function confirmDeleteLog(logId, logPreview) {
    if (confirm(`Are you sure you want to delete this log entry?\n\n"${logPreview}"\n\nThis action cannot be undone.`)) {
        // Create and submit delete form
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/job/{{ job.id }}/logs/${logId}/delete`;

        // Add CSRF token
        const csrfToken = document.querySelector('input[name="csrf_token"]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
